"use strict";function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _get(t,e,i){return(_get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(t,e,i){var n=_superPropBase(t,e);if(n){var r=Object.getOwnPropertyDescriptor(n,e);return r.get?r.get.call(i):r.value}})(t,e,i||t)}function _superPropBase(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=_getPrototypeOf(t)););return t}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&_setPrototypeOf(t,e)}function _setPrototypeOf(t,e){return(_setPrototypeOf=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function _createSuper(t){var e=_isNativeReflectConstruct();return function(){var i,n=_getPrototypeOf(t);if(e){var r=_getPrototypeOf(this).constructor;i=Reflect.construct(n,arguments,r)}else i=n.apply(this,arguments);return _possibleConstructorReturn(this,i)}}function _possibleConstructorReturn(t,e){return!e||"object"!==_typeof(e)&&"function"!=typeof e?_assertThisInitialized(t):e}function _assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(t){return!1}}function _getPrototypeOf(t){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function _instanceof(t,e){return null!=e&&"undefined"!=typeof Symbol&&e[Symbol.hasInstance]?!!e[Symbol.hasInstance](t):t instanceof e}function _classCallCheck(t,e){if(!_instanceof(t,e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function _createClass(t,e,i){return e&&_defineProperties(t.prototype,e),i&&_defineProperties(t,i),t}var wpdEditorCounter=function(){function t(e,i){_classCallCheck(this,t),this.quill=e,this.options=i,this.maxCount=i.maxcount,this.minCount=i.mincount,this.container=document.getElementById("wpd-editor-char-counter-"+i.uniqueID),this.submit=document.getElementById("wpd-field-submit-"+i.uniqueID),e.on("editor-change",this.update.bind(this)),this.update()}return _createClass(t,[{key:"calculate",value:function(){var t=this.quill.getText().length,e=this.quill.container.id,i=document.querySelectorAll("#".concat(e," .ql-editor img"));return i.length&&i.forEach(function(e){null!==e.src.match(/https\:\/\/s\.w\.org\/images\/core\/emoji/gi)?t+=e.alt.length:e.classList.contains("wpdem-sticker")?t+=e.alt.length:t+=e.src.length}),t}},{key:"update",value:function(){var t=this.calculate(),e=t-1;if(this.maxCount>0&&t>=this.maxCount&&this.quill.deleteText(this.maxCount,t),this.maxCount>0){var i=this.maxCount-e;this.container.innerText=i>=0?i:0,t+10>this.maxCount?this.container.classList.add("error"):this.container.classList.remove("error")}else this.container&&this.container.remove()}}]),t}();Quill.register("modules/counter",wpdEditorCounter);var Link=Quill.import("formats/link"),wpdEditorLink=function(t){_inherits(i,Link);var e=_createSuper(i);function i(){return _classCallCheck(this,i),e.apply(this,arguments)}return _createClass(i,null,[{key:"create",value:function(t){var e=_get(_getPrototypeOf(i),"create",this).call(this,t);t=this.sanitize(t),e.setAttribute("href",t);var n=location.protocol+"//"+location.hostname;return(t.startsWith(n)||"#"===t.charAt(0)||"/"===t.charAt(0)&&"/"!==t.charAt(1))&&e.removeAttribute("target"),e}},{key:"sanitize",value:function(t){var e=_get(_getPrototypeOf(i),"sanitize",this).call(this,t),n=e.slice(0,e.indexOf(":"));return"#"!==e.charAt(0)&&"/"!==e.charAt(0)&&-1===this.PROTOCOL_WHITELIST.indexOf(n)&&(e="http://"+t),e}}]),i}();Quill.register(wpdEditorLink,!0);var WpdEditor=function(){function t(){_classCallCheck(this,t),this.editorWraperPrefix="wpd-editor-wraper",this.textEditorContainer="ql-texteditor",this.textEditorPrefix="wc-textarea",this.editorToolbarPrefix="wpd-editor-toolbar",this.sourceCodeButtonName="sourcecode",this.spoiler="spoiler",this.spoilerPromtTitle=wpdiscuzAjaxObj.wc_spoiler_title,this._container="",this._uniqueid="",this.currentEditor=null,this._editors=new Map,this._handlers=new Map,this._initDefaults()}return _createClass(t,[{key:"addButtonEventHandler",value:function(t,e){this._handlers.set(t,e)}},{key:"createEditor",value:function(t){var e=this;if(this.container=t,this._editors.has(this.uniqueid))this.currentEditor=this._editors.get(this.uniqueid);else{var i="#".concat(this.editorToolbarPrefix,"-").concat(this.uniqueid);wpdiscuzEditorOptions.modules.toolbar=i,wpdiscuzEditorOptions.modules.counter.uniqueID=this.uniqueid;var n=new Quill(this.container,wpdiscuzEditorOptions);n.on("editor-change",function(t){null!==(arguments.length<=1?void 0:arguments[1])&&(e.currentEditor=n,e.container=n.container.id)}),n.clipboard.addMatcher("a",function(t,e){return t.getAttribute("href")===t.innerHTML?new(Quill.import("delta"))([{insert:t.innerHTML}]):e}),document.querySelectorAll("".concat(i," button")).forEach(function(t){t.onclick=function(){e.currentEditor=n,e.container=n.container.id;var i=t.dataset.wpde_button_name;void 0!==i&&"string"==typeof i&&""!==i.trim()&&e._handlers.has(i)&&e._handlers.get(i)(e.currentEditor,e.uniqueid)}}),this._bindTextEditor(n),this._editors.set(this.uniqueid,n),document.getElementById("".concat(this.editorWraperPrefix,"-").concat(this.uniqueid)).style.display=""}return this.currentEditor}},{key:"removeEditor",value:function(t){this.container=t,this._editors.has(this.uniqueid)&&this._editors.delete(this.uniqueid)}},{key:"_bindTextEditor",value:function(t){var e="".concat(this.textEditorPrefix,"-").concat(this.uniqueid),i=document.getElementById(e);i&&(i.style.cssText="display: none;",t.addContainer(this.textEditorContainer).appendChild(i)),this.currentEditor=t}},{key:"_findUniqueId",value:function(){return this.container.substring(this.container.lastIndexOf("-")+1)}},{key:"_initDefaults",value:function(){var t=this;this.addButtonEventHandler(this.sourceCodeButtonName,function(e){document.getElementById("".concat(t.textEditorPrefix,"-").concat(t.uniqueid));var i=document.getElementById("wpd-editor-source-code-wrapper-bg"),n=document.getElementById("wpd-editor-source-code-wrapper"),r=document.getElementById("wpd-editor-source-code"),o=document.getElementById("wpd-editor-uid");i.style.display="block",n.style.display="block",o.value=e.container.id,r.value=e.root.innerHTML}),this.addButtonEventHandler(this.spoiler,function(e){var i=prompt(t.spoilerPromtTitle);if(null!==i){var n=' [spoiler title="'.concat(i,'"] '),r=e.getSelection();null===r&&(r={index:e.getLength()-1,length:0}),0===r.length?(e.insertText(r.index,n+" [/spoiler] ",Quill.sources.USER),e.setSelection(r.index+n.length,Quill.sources.USER)):(e.insertText(r.index,n),e.insertText(r.index+n.length+r.length," [/spoiler] ",Quill.sources.USER),e.setSelection(r.index+n.length+r.length+" [/spoiler] ".length,Quill.sources.USER))}})}},{key:"uniqueid",set:function(t){""!==t&&"string"==typeof t?this._uniqueid=t:""===t?this._uniqueid=this._findUniqueId():console.error("Incorrect uniqueid.")},get:function(){return this._uniqueid}},{key:"container",set:function(t){""!==t&&"string"==typeof t?(this._container=t,this.uniqueid=this._findUniqueId()):console.error("Incorrect uniqueid.")},get:function(){return this._container}}]),t}();